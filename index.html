import React, { useState, useEffect, useRef } from 'react';

// 預設初始數據 (來自上傳的 2026_Scripts.txt)
const DEFAULT_DATA = [
  { section: "自我介紹", title: "14年經驗與三個階段", content_zh: "我是一位擁有 PMP 證照、具備 14 年跨領域經驗的專案與數位轉型工作者...", content_en: "I’m a PMP-certified program and transformation professional with over 14 years of cross-domain experience..." },
  { section: "離職原因", title: "SoftBI 商智資訊", content_zh: "完成了當初加入時被賦予的使命。我意識到自己已經走完了在中小企業「從 0 到 1」的旅程。", content_en: "I completed the mission I was hired for. I realized I had completed my full SME career loop — from zero to one." },
  { section: "困難題 (SEEI)", title: "最大缺點 (Execution vs Governance)", content_zh: "S｜我最大的缺點是我過去一路把自己訓練成「能帶治理、也能親自落地」的人。\nE｜這題真正考的是：在不同階段要怎麼切換比例。\nE｜以商智資訊為例，我先下第一線釐清規則才建立治理制度。\nI｜現在我會根據專案階段主動切換模式。", content_en: "S｜My biggest weakness is I operate in two modes: hands-on and governance.\nE｜The challenge is balancing these across different phases.\nE｜At SoftBI, I went hands-on to build the logic before scaling to automation.\nI｜I treat this as a controlled strategy to ensure ground truth." },
  { section: "為什麼雇用我", title: "跨 Domain + 前90天", content_zh: "S｜雇用我不是因為我最懂電商，而是我擅長在不確定性中建立可交付計畫。\nE｜我能讓平台持續對齊 Business Goal。\nE｜前90天：1.釐清目標 2.翻譯 Roadmap 3.建立節奏。\nI｜讓團隊從需求很滿變成交付可預期。", content_en: "S｜Hire me for my ability to turn ambiguity into delivery plans.\nE｜I align platforms with long-term strategy and data quality.\nE｜First 90 days: 1.Align outcomes 2.Map dependencies 3.Establish rhythm.\nI｜I move teams from 'chaos' to 'predictable' from day one." },
  { section: "反問問題", title: "ASUS 戰略相關", content_zh: "ASUS 如何計畫將電商平台、數據治理與 Ubiquitous AI 願景整合進長期的數位策略中？", content_en: "How does ASUS plan to integrate the e-commerce platform, data governance, and the Ubiquitous AI vision into one long-term scalable digital strategy?" }
];

const SECTIONS = ["自我介紹", "離職原因", "優缺點", "困難題 (SEEI)", "反問問題"];

export default function App() {
  const [data, setData] = useState(() => {
    const saved = localStorage.getItem('interview_data');
    return saved ? JSON.parse(saved) : DEFAULT_DATA;
  });
  const [activeSection, setActiveSection] = useState(SECTIONS[0]);
  const [isEditing, setIsEditing] = useState(null); // stores index or 'new'
  const [editForm, setEditForm] = useState({ section: '', title: '', content_zh: '', content_en: '' });
  const [gasUrl, setGasUrl] = useState(localStorage.getItem('gas_url') || '');
  const [isSyncing, setIsSyncing] = useState(false);
  const [speechRate, setSpeechRate] = useState(0.9);
  const [showSettings, setShowSettings] = useState(false);

  useEffect(() => {
    localStorage.setItem('interview_data', JSON.stringify(data));
  }, [data]);

  useEffect(() => {
    localStorage.setItem('gas_url', gasUrl);
  }, [gasUrl]);

  // TTS 功能
  const speak = (text) => {
    window.speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'en-US';
    utterance.rate = speechRate;
    window.speechSynthesis.speak(utterance);
  };

  // 同步功能 (Pull)
  const pullData = async () => {
    if (!gasUrl) return alert("請先設定 GAS URL");
    setIsSyncing(true);
    try {
      const resp = await fetch(gasUrl);
      const json = await resp.json();
      if (Array.isArray(json)) {
        setData(json);
        alert("同步成功！");
      }
    } catch (e) {
      alert("同步失敗: " + e.message);
    } finally {
      setIsSyncing(false);
    }
  };

  // 同步功能 (Push)
  const pushData = async () => {
    if (!gasUrl) return alert("請先設定 GAS URL");
    setIsSyncing(true);
    try {
      await fetch(gasUrl, {
        method: 'POST',
        mode: 'no-cors', // GAS post often needs no-cors or redirect handling
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      alert("已發送更新請求 (Note: no-cors 模式無法確認結果，請檢查試算表)");
    } catch (e) {
      alert("更新失敗: " + e.message);
    } finally {
      setIsSyncing(false);
    }
  };

  const handleEdit = (index) => {
    setIsEditing(index);
    setEditForm(data[index]);
  };

  const handleAddNew = () => {
    setIsEditing('new');
    setEditForm({ section: activeSection, title: '', content_zh: '', content_en: '' });
  };

  const saveEdit = () => {
    const newData = [...data];
    if (isEditing === 'new') {
      newData.push(editForm);
    } else {
      newData[isEditing] = editForm;
    }
    setData(newData);
    setIsEditing(null);
  };

  const deleteItem = (index) => {
    if (window.confirm("確定刪除？")) {
      const newData = data.filter((_, i) => i !== index);
      setData(newData);
      setIsEditing(null);
    }
  };

  return (
    <div className="min-h-screen bg-slate-50 flex flex-col pt-[env(safe-area-inset-top)] pb-[env(safe-area-inset-bottom)]">
      {/* 頂部導航 */}
      <header className="bg-white border-b sticky top-0 z-10 p-4 flex justify-between items-center shadow-sm">
        <h1 className="text-xl font-bold text-slate-800">2026 面試教練</h1>
        <button 
          onClick={() => setShowSettings(!showSettings)}
          className="p-2 rounded-full hover:bg-slate-100 transition-colors"
        >
          <SettingsIcon />
        </button>
      </header>

      {/* 設置面板 */}
      {showSettings && (
        <div className="bg-white p-4 border-b animate-in slide-in-from-top">
          <div className="space-y-4">
            <div>
              <label className="block text-xs font-bold text-slate-500 uppercase mb-1">GAS Web App URL</label>
              <input 
                value={gasUrl} 
                onChange={(e) => setGasUrl(e.target.value)}
                placeholder="https://script.google.com/..." 
                className="w-full p-2 border rounded text-sm bg-slate-50"
              />
            </div>
            <div>
              <label className="block text-xs font-bold text-slate-500 uppercase mb-1">TTS 語速: {speechRate}</label>
              <input 
                type="range" min="0.5" max="1.5" step="0.1" 
                value={speechRate} 
                onChange={(e) => setSpeechRate(parseFloat(e.target.value))}
                className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer"
              />
            </div>
            <div className="flex gap-2">
              <button 
                disabled={isSyncing}
                onClick={pullData}
                className={`flex-1 p-2 rounded text-white text-sm font-medium ${isSyncing ? 'bg-slate-300' : 'bg-blue-600'}`}
              >
                {isSyncing ? '同步中...' : '從雲端下載 (Pull)'}
              </button>
              <button 
                disabled={isSyncing}
                onClick={pushData}
                className={`flex-1 p-2 rounded text-white text-sm font-medium ${isSyncing ? 'bg-slate-300' : 'bg-green-600'}`}
              >
                上傳到雲端 (Push)
              </button>
            </div>
          </div>
        </div>
      )}

      {/* 章節切換 */}
      <div className="flex overflow-x-auto bg-white whitespace-nowrap scrollbar-hide border-b shadow-inner">
        {SECTIONS.map(s => (
          <button
            key={s}
            onClick={() => setActiveSection(s)}
            className={`px-4 py-3 text-sm font-medium transition-all ${
              activeSection === s ? 'text-blue-600 border-b-2 border-blue-600 bg-blue-50/50' : 'text-slate-500'
            }`}
          >
            {s}
          </button>
        ))}
      </div>

      {/* 主要內容 */}
      <main className="flex-1 overflow-y-auto p-4 space-y-4">
        {data
          .map((item, index) => ({ ...item, originalIndex: index }))
          .filter(item => item.section === activeSection)
          .map((item) => (
            <div key={item.originalIndex} className="bg-white rounded-2xl p-4 shadow-sm border border-slate-100 flex flex-col gap-3">
              <div className="flex justify-between items-start">
                <h3 className="font-bold text-slate-800 text-lg">{item.title}</h3>
                <div className="flex gap-1">
                  <button onClick={() => handleEdit(item.originalIndex)} className="p-2 text-slate-400 hover:text-blue-500">
                    <EditIcon />
                  </button>
                </div>
              </div>
              
              <div className="space-y-3">
                <div className="text-slate-600 text-sm leading-relaxed bg-slate-50 p-3 rounded-xl border border-dashed">
                  {item.content_zh}
                </div>
                <div className="text-slate-800 text-sm font-medium leading-relaxed p-3 rounded-xl bg-blue-50/30 border border-blue-100 relative group">
                  {item.content_en}
                  <button 
                    onClick={() => speak(item.content_en)}
                    className="absolute bottom-2 right-2 bg-white/80 backdrop-blur shadow-sm p-2 rounded-full hover:scale-110 active:scale-90 transition-transform"
                  >
                    <PlayIcon />
                  </button>
                </div>
              </div>
            </div>
          ))}

        <button 
          onClick={handleAddNew}
          className="w-full py-4 border-2 border-dashed border-slate-300 rounded-2xl text-slate-400 font-medium flex items-center justify-center gap-2 hover:bg-slate-100"
        >
          <PlusIcon /> 新增卡片
        </button>
      </main>

      {/* 編輯 Modal */}
      {isEditing !== null && (
        <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center p-0 sm:p-4 bg-black/40 backdrop-blur-sm">
          <div className="bg-white w-full max-w-lg rounded-t-3xl sm:rounded-3xl shadow-2xl p-6 animate-in slide-in-from-bottom flex flex-col gap-4 max-h-[90vh] overflow-y-auto">
            <div className="flex justify-between items-center">
              <h2 className="text-xl font-bold">{isEditing === 'new' ? '新增內容' : '編輯內容'}</h2>
              <button onClick={() => setIsEditing(null)} className="p-2 rounded-full hover:bg-slate-100 text-slate-400">✕</button>
            </div>
            
            <div className="space-y-3">
              <select 
                className="w-full p-3 bg-slate-100 rounded-xl border-none outline-blue-500"
                value={editForm.section}
                onChange={e => setEditForm({...editForm, section: e.target.value})}
              >
                {SECTIONS.map(s => <option key={s} value={s}>{s}</option>)}
              </select>
              <input 
                placeholder="標題"
                className="w-full p-3 bg-slate-100 rounded-xl border-none outline-blue-500"
                value={editForm.title}
                onChange={e => setEditForm({...editForm, title: e.target.value})}
              />
              <textarea 
                placeholder="中文腳本" rows="4"
                className="w-full p-3 bg-slate-100 rounded-xl border-none outline-blue-500 text-sm"
                value={editForm.content_zh}
                onChange={e => setEditForm({...editForm, content_zh: e.target.value})}
              />
              <textarea 
                placeholder="英文腳本" rows="4"
                className="w-full p-3 bg-blue-50 rounded-xl border-none outline-blue-500 text-sm font-medium"
                value={editForm.content_en}
                onChange={e => setEditForm({...editForm, content_en: e.target.value})}
              />
            </div>

            <div className="flex gap-2 pt-2">
              {isEditing !== 'new' && (
                <button onClick={() => deleteItem(isEditing)} className="flex-1 py-3 bg-red-50 text-red-600 rounded-xl font-bold">刪除</button>
              )}
              <button onClick={saveEdit} className="flex-[2] py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-200">儲存變更</button>
            </div>
          </div>
        </div>
      )}

      {/* 全域同步中遮罩 */}
      {isSyncing && (
        <div className="fixed inset-0 bg-white/80 z-[100] flex flex-col items-center justify-center backdrop-blur-md">
          <div className="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
          <p className="mt-4 font-bold text-slate-700 tracking-widest">雲端同步中...</p>
        </div>
      )}
    </div>
  );
}

// 小圖標組件
const SettingsIcon = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>;
const PlayIcon = () => <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" className="text-blue-600"><path d="M5 3l14 9-14 9V3z"/></svg>;
const EditIcon = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>;
const PlusIcon = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>;
